# 离线转写开发待办清单

  - [x] 1. 初始化离线运行时目录与清单
      - 提示词：

        你是一位资深的Electron项目架构师，请在 `resources/runtime/` 下创建 `whisper/` 与 `bin/` 目录结构，并
        生成示例 `manifest.json`。示例代码（Node 脚本片段）：
        ```js
        const fs = require("fs");
        const path = require("path");
        const base = path.join(__dirname, "resources/runtime");
        fs.mkdirSync(path.join(base, "whisper"), {recursive: true});
        fs.writeFileSync(path.join(base, "manifest.json"), JSON.stringify({version: "0.0.0"}, null, 2));
        约束与风险：只创建必要目录和示例文件，不下载真实模型，不覆盖已有文件。
        输出格式：使用编号小节说明创建的文件和内容。
        检查清单：
          - [x] resources/runtime/whisper/ 目录存在且无意外内容
          - [x] 生成的 manifest.json 包含 version、files 占位字段
          - [ ] 运行脚本不会抛出异常


  - [x] 2. 搭建 npm run setup-offline 脚本骨架
      - 提示词：

        你是一位资深的Node脚本工程师，请在 `scripts/setup-offline.js` 中编写骨架脚本，实现：
        1. 读取 `resources/runtime/manifest.json`
        2. 依次校验 `yt-dlp`, `ffmpeg`, `whisper` 可执行文件是否存在（仅检测，不下载）
        3. 输出缺失项列表
        示例代码结构：
        ```js
        const required = [
          {name: "yt-dlp", path: "resources/runtime/bin/yt-dlp"},
          ...
        ];
        约束：不要真正执行下载；脚本需在 macOS/Linux/Windows 可运行。
        输出：以 Markdown 表格列出依赖状态。
        检查清单：
          - [x] package.json 添加 setup-offline npm script
          - [x] 运行 npm run setup-offline 时显示存在/缺失状态
          - [x] 缺失文件时退出码为 1，全部就绪时为 0


  - [x] 3. 设计作业状态机模块（ultrathink）
      - 提示词：

        ultrathink 你是一位资深架构师，请在 `src/jobs/queue.js` 中实现可扩展的作业状态机，具备：
        - 状态集合：PENDING, DOWNLOADING, EXTRACTING, TRANSCRIBING, PACKING, COMPLETED, FAILED, CANCELLED
        - 事件驱动：`advanceStage(jobId, nextStage)`，自动更新时间戳
        - 订阅机制：`subscribe(listener)` 接收状态变更回调
        示例接口定义：
        ```js
        class JobQueue {
          add(job) {}
          advanceStage(id, stage) {}
        }
        module.exports = new JobQueue();
        禁止与子进程耦合，先实现内存数据结构与导出接口。
        输出：以模块文档块注释描述使用方式。
        检查清单：
          - [x] 可添加/查询作业，状态按顺序推进
          - [x] 非法状态转换会抛出错误
          - [x] 有最少2个单元测试覆盖成功与失败路径


  - [x] 4. 实现下载阶段封装
      - 提示词：

        你是一位资深Electron后端工程师，请在 `src/jobs/download.js` 中封装 `yt-dlp-wrap-plus`：
        - 暴露 `download(job, onProgress)` 函数
        - 支持传入输出目录与格式化文件名
        - 将 `progress.percent` 四舍五入传给 `onProgress`
        示例调用：
        ```js
        const {download} = require("./download");
        await download(job, pct => queue.advanceStage(job.id, {stage: "DOWNLOADING", percent: pct}));
        约束：不要直接写磁盘路径，统一使用作业目录参数；捕获错误并抛出自定义 DownloadError。
        输出：返回下载完成的视频文件路径。
        检查清单：
          - [x] 单元测试模拟成功下载和网络错误
          - [x] 错误时附带源 URL 与错误码
          - [x] 进度回调调用次数不少于2次（通过测试断言）


  - [ ] 5. 实现音频提取与转码模块
      - 提示词：

        你是一位资深ffmpeg集成工程师，请在 `src/jobs/audio.js` 中实现 `extractAudio(videoPath, options)`：
        - 使用 `ffmpeg` 将视频转换为 mp3，支持比特率选项（默认192k）
        - 可选参数决定是否生成 wav
        示例命令：
        ```js
        spawn(ffmpegPath, ["-y", "-i", videoPath, "-b:a", bitrate, outputMp3]);
        约束：使用 child_process.spawn，流式捕获日志；出错时返回 AudioExtractError。
        输出：返回 {mp3Path, wavPath}。
        检查清单：
          - [ ] 模块暴露路径可由调用方配置
          - [ ] mp3 与可选 wav 成功生成（测试中使用短样本）
          - [ ] 错误日志写入提供的日志流接口（mock 验证）


  - [ ] 6. 封装 Whisper Metal 调用
      - 提示词：

        你是一位资深本地推理工程师，请在 `src/jobs/transcribe.js` 中实现 `transcribe(job, audioPath,
        opts)`：
        - 默认命令包含 `--encoder metal`，支持 fallback 参数
        - 解析 stdout 中的 `[percent]` 片段并回调 `onProgress`
        - 产出 `transcript.txt` 写入作业目录
        示例命令拼装：
        ```js
        const args = ["--model", modelPath, "--file", audioPath, "--output-format", "txt", "--print-
        progress"];
        if (useMetal) args.push("--encoder", "metal");
        约束：Metal 初始化错误时捕获并记录，自动切换 CPU；禁止硬编码模型路径。
        输出：返回转写文件路径与耗时。
        检查清单：
          - [ ] 支持自定义模型与参数（传入 opts）
          - [ ] 解析进度精度误差不超过±1%
          - [ ] CPU fallback 情况下有明确日志提示


  - [ ] 7. 集成主进程作业编排
      - 提示词：

        你是一位资深Electron主进程工程师，请在 `main.js` 中：
        - 注册 `job:create`, `job:cancel`, `job:list` IPC
        - 调用 `queue`、`download`、`audio`、`transcribe` 模块串联执行
        - 在每个阶段通过 `webContents.send("job:progress", payload)` 推送进度
        示例阶段串联：
        ```js
        const video = await download(job, pct => emit(job.id, "DOWNLOADING", pct));
        const audio = await extractAudio(video.path, job.options);
        const transcript = await transcribe(job, audio.wav || audio.mp3, options);
        约束：确保每个阶段的错误会写入 metadata 并返回 job:result；不要阻塞 UI 线程。
        输出：整理完成的 metadata.json 并写磁盘。
        检查清单：
          - [ ] 创建作业后立即返回 jobId
          - [ ] 失败后状态为 FAILED，包含错误 stage
          - [ ] 顺序执行且可取消（调用 cancel 终止子进程）


  - [ ] 8. 构建 Renderer 转写页面
      - 提示词：

        你是一位资深Electron前端工程师，请创建 `html/transcribe.html` 与 `src/transcribe.js`：
        - 表单包含：URL、输出目录、语言选择、保留视频的复选框
        - 作业列表显示状态、进度条、操作按钮（打开目录、重试、取消）
        - 日志面板可切换显示
        示例DOM结构：
        ```html
        <form id="job-form">...</form>
        <ul id="job-list"></ul>
        <pre id="job-log"></pre>
        约束：使用现有样式体系（复用 assets/css）；通过 IPC 调用后端，不直接访问文件系统。
        输出：在 Renderer 中注册并导航入口按钮。
        检查清单：
          - [ ] 表单校验可阻止空URL提交
          - [ ] 收到 job:progress 时更新进度条
          - [ ] 点击「打开目录」调用 ipcRenderer.invoke("job:open-dir", jobId)


  - [ ] 9. 实现离线依赖检查 UI 与 IPC
      - 提示词：

        你是一位资深Electron全栈工程师，请在 Renderer 中新增「离线依赖检查」按钮，并通过 `deps:check` IPC 调
        用 `setup-offline` 逻辑：
        - 显示状态列表（已安装/缺失）
        - 如果缺失，提供操作提示（例如打开说明文档）
        示例渲染：
        ```js
        const result = await ipcRenderer.invoke("deps:check");
        renderTable(result.items);
        约束：按钮需在设置或工具栏中可见；调用不可阻塞主线程。
        输出：依赖检查结果以模态或抽屉显示，带时间戳。
        检查清单：
          - [ ] 缺失项显示红色标记并含原因
          - [ ] 成功项显示绿色并含版本号
          - [ ] UI 关闭后资源释放（事件解绑）


  - [ ] 10. 写入作业日志与诊断导出
      - 提示词：

        你是一位资深日志系统工程师，请在主进程中实现 `logs.js` 工具：
        - 提供 `createJobLogger(jobId)` 返回写入 `downloads/<jobId>/logs.txt` 的函数
        - 支持 `exportDiagnostics(jobId)`，打包 `metadata.json` + `logs.txt`（zip或tar）
        示例：
        ```js
        const logger = createJobLogger(job.id);
        logger.info("download started");
        约束：使用 Node 内置模块或轻量依赖；注意并发写入的文件锁。
        输出：在 Renderer 中添加「导出诊断包」按钮。
        检查清单：
          - [ ] 每个作业日志文件至少追加五种类型的日志（info/error等）
          - [ ] 导出文件包含必要元数据且大小合理
          - [ ] 无作业时导出操作提示用户